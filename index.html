<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Idi Nahui Clicker - Ultimate Edition Beta 8.0">
    <title>Idi Nahui Clicker: Ultimate 8.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;700;900&family=Rubik+Glitch&family=Shojumaru&display=swap" rel="stylesheet">

    <style>
        /* * ======================================================================================
         * 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –¢–ï–ú–´ (ROOT VARIABLES)
         * ======================================================================================
         */
        :root {
            /* –ë–∞–∑–æ–≤–∞—è —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ */
            --bg-color: #050505;
            --bg-gradient: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            
            --panel-bg: rgba(30, 30, 30, 0.85);
            --panel-border: 1px solid rgba(255, 255, 255, 0.08);
            --panel-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            
            --text-main: #ffffff;
            --text-secondary: #aaaaaa;
            
            --accent-color: #ff4e50;
            --accent-glow: rgba(255, 78, 80, 0.6);
            
            --btn-grad-start: #ff4e50;
            --btn-grad-end: #960000;
            
            --input-bg: rgba(0, 0, 0, 0.5);
            --input-text: #fff;
            
            /* –†–µ–¥–∫–æ—Å—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ */
            --rarity-common: #3498db;
            --rarity-rare: #2ecc71;
            --rarity-ultra: #ff2a2a;
            --rarity-legend: #f1c40f;
            
            /* –°–∏—Å—Ç–µ–º–Ω—ã–µ */
            --transition-speed: 0.3s;
            --glass-blur: blur(12px);
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        body.light-mode {
            --bg-color: #f0f2f5;
            --bg-gradient: radial-gradient(circle at center, #ffffff 0%, #e6e9f0 100%);
            
            --panel-bg: rgba(255, 255, 255, 0.9);
            --panel-border: 1px solid rgba(0, 0, 0, 0.05);
            --panel-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            
            --text-main: #111111;
            --text-secondary: #555555;
            
            --accent-color: #ff4e50;
            
            --input-bg: rgba(0, 0, 0, 0.05);
            --input-text: #000;
        }

        /* * ======================================================================================
         * 2. –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò (RESET & BASE)
         * ======================================================================================
         */
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-gradient);
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            transition: background 0.5s ease, color 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –§–æ–Ω–æ–≤—ã–π —à—É–º –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.5;
            pointer-events: none;
            z-index: 0;
        }

        /* –ö–∞–Ω–≤–∞—Å –¥–ª—è —á–∞—Å—Ç–∏—Ü */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        /* * ======================================================================================
         * 3. –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê –ò –ó–ê–ì–û–õ–û–í–ö–ò (TYPOGRAPHY)
         * ======================================================================================
         */
        
        /* –ù–µ—Ä–µ–∞–ª—å–Ω–æ –∫—Ä–∞—Å–∏–≤—ã–π —Ä–∞–¥—É–∂–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        .ultimate-title {
            font-family: 'Shojumaru', cursive;
            font-size: 3.5rem;
            text-align: center;
            margin: 0;
            line-height: 1.2;
            z-index: 5;
            position: relative;
            
            /* –†–∞–¥—É–∂–Ω–∞—è –º–∞–≥–∏—è */
            background: linear-gradient(
                to right, 
                #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff, #ff0000
            );
            background-size: 300% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            
            animation: rainbowFlow 4s linear infinite;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3));
        }

        @keyframes rainbowFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .subtitle-text {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-secondary);
            margin-top: 5px;
            margin-bottom: 20px;
            text-align: center;
            opacity: 0.8;
            z-index: 5;
        }

        /* –°—á–µ—Ç */
        .score-big {
            font-size: 6.5rem;
            font-weight: 900;
            margin: 0;
            line-height: 1;
            z-index: 5;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }

        /* –ü–æ–¥–ø–∏—Å—å –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π */
        .bottom-label {
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent-color);
            text-transform: uppercase;
            margin-top: 20px;
            z-index: 5;
            letter-spacing: 2px;
        }

        /* * ======================================================================================
         * 4. –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê (CORE BUTTON)
         * ======================================================================================
         */
        .click-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }

        #main-btn {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            border: 8px solid rgba(255, 255, 255, 0.15);
            background: linear-gradient(135deg, var(--btn-grad-start), var(--btn-grad-end));
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.5),
                inset 0 10px 20px rgba(255,255,255,0.3),
                inset 0 -10px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.05s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
        #main-btn:active {
            transform: scale(0.92);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        /* –†–∞–¥—É–∂–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
        .rainbow-mode-btn {
            background: linear-gradient(
                124deg, 
                #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3
            ) !important;
            background-size: 1800% 1800% !important;
            animation: rainbowBgAnim 2s ease infinite !important; /* –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–ª–∏–≤–∞–Ω–∏–µ */
            border-color: rgba(255,255,255,0.5) !important;
            box-shadow: 0 0 50px rgba(255, 0, 200, 0.5) !important;
        }

        @keyframes rainbowBgAnim { 
            0%{background-position:0% 82%}
            50%{background-position:100% 19%}
            100%{background-position:0% 82%}
        }

        /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç (+1) */
        .click-float {
            position: absolute;
            font-size: 2.5rem;
            font-weight: 900;
            color: #fff;
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            animation: floatUpFade 0.7s ease-out forwards;
        }

        @keyframes floatUpFade {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-120px) scale(1.5); opacity: 0; }
        }

        /* * ======================================================================================
         * 5. –ò–ù–¢–ï–†–§–ï–ô–° –ú–ï–ù–Æ –ò –ù–ê–í–ò–ì–ê–¶–ò–ò
         * ======================================================================================
         */
        
        /* –î–æ–∫ —Å –∏–∫–æ–Ω–∫–∞–º–∏ */
        .dock-panel {
            position: fixed;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 50;
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .dock-btn {
            width: 60px;
            height: 60px;
            border-radius: 20px;
            background: var(--panel-bg);
            border: var(--panel-border);
            color: var(--text-main);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .dock-btn:hover {
            transform: scale(1.15) translateX(-5px);
            background: var(--accent-color);
            color: #fff;
            box-shadow: 0 0 20px var(--accent-color);
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        @media (max-width: 768px) {
            .dock-panel {
                right: 50%;
                top: auto;
                bottom: 20px;
                transform: translateX(50%);
                flex-direction: row;
                width: 90%;
                justify-content: space-around;
                padding: 10px;
            }
            .dock-btn:hover { transform: scale(1.15) translateY(-5px); }
            
            .ultimate-title { font-size: 2.2rem; }
            #score-display { font-size: 5rem; }
            #main-btn { width: 220px; height: 220px; }
        }

        /* * ======================================================================================
         * 6. –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê (MODALS)
         * ======================================================================================
         */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: var(--glass-blur);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--panel-bg);
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            border-radius: 35px;
            padding: 30px;
            border: var(--panel-border);
            box-shadow: var(--panel-shadow);
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª–∫–∏ */
        .m-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }

        .m-title {
            font-family: 'Shojumaru', cursive;
            color: var(--accent-color);
            margin: 0;
            font-size: 1.8rem;
            letter-spacing: 2px;
        }

        /* –ö—Ä–µ—Å—Ç–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è */
        .close-icon {
            position: absolute;
            top: 20px;
            right: 25px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-secondary);
            transition: 0.3s;
            line-height: 0;
        }
        .close-icon:hover { color: var(--accent-color); transform: rotate(90deg); }

        /* UI –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–æ–∫ */
        .ui-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            font-family: 'Montserrat';
            width: 100%;
            margin-top: 10px;
        }
        .ui-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .ui-btn:active { transform: scale(0.98); }
        
        .ui-btn.primary { background: var(--accent-color); }
        .ui-btn.danger { background: #c0392b; }
        .ui-btn.info { background: #3498db; }

        /* * ======================================================================================
         * 7. –≠–õ–ï–ú–ï–ù–¢–´ –ú–ê–ì–ê–ó–ò–ù–ê, –ò–ù–í–ï–ù–¢–ê–†–Ø –ò –ù–ê–°–¢–†–û–ï–ö
         * ======================================================================================
         */
        
        /* –ú–∞–≥–∞–∑–∏–Ω */
        .shop-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .shop-row:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); }
        
        .item-icon { font-size: 2rem; margin-right: 15px; }
        .item-details { flex-grow: 1; text-align: left; }
        .item-name { font-weight: 800; font-size: 0.9rem; color: var(--text-main); }
        .item-desc { font-size: 0.7rem; color: var(--text-secondary); }
        
        .price-badge { 
            background: #222; 
            padding: 5px 10px; 
            border-radius: 8px; 
            font-size: 0.8rem; 
            color: #f1c40f; 
            font-weight: bold;
        }

        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .inv-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .inv-item {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            border-bottom: 3px solid #555;
            position: relative;
        }
        .inv-count {
            position: absolute; top: 5px; right: 5px;
            background: var(--accent-color); color: white;
            font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; font-weight: 900;
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–∞ */
        .colors-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 15px 0; }
        .c-dot {
            width: 100%; aspect-ratio: 1; border-radius: 50%;
            cursor: pointer; border: 3px solid transparent; transition: 0.3s;
            position: relative;
        }
        .c-dot.active { transform: scale(1.2); border-color: white; box-shadow: 0 0 15px currentColor; }
        .c-dot.locked { filter: grayscale(1); opacity: 0.5; }
        .c-dot.locked::after { content: 'üîí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 12px; }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–æ–≤ */
        .lang-flags { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .flag-btn {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; opacity: 0.5; transition: 0.3s;
        }
        .flag-btn.active { opacity: 1; transform: scale(1.1); }
        .flag-img { font-size: 2rem; }
        .flag-label { font-size: 0.7rem; font-weight: 900; margin-top: 5px; }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }
        .auth-box {
            background: var(--panel-bg); padding: 40px; border-radius: 40px;
            text-align: center; border: 1px solid var(--modal-border);
            width: 90%; max-width: 380px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .nice-input {
            width: 100%; padding: 15px; margin: 10px 0;
            border-radius: 12px; border: none;
            background: var(--input-bg); color: var(--input-text);
            font-size: 1rem; text-align: center; font-weight: 600;
        }

        /* –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã */
        .fortune-container {
            width: 100%; height: 100px; background: #000;
            border: 4px solid var(--accent-color); border-radius: 15px;
            overflow: hidden; position: relative; margin-bottom: 20px;
        }
        .fortune-tape {
            display: flex; height: 100%; position: absolute; left: 0;
            transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1);
        }
        .fortune-cell {
            min-width: 80px; height: 100%; display: flex;
            align-items: center; justify-content: center; font-size: 2rem;
            border-right: 1px solid #333; color: white; background: #111;
        }
        .fortune-arrow {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 4px; height: 100%; background: red; z-index: 10;
            box-shadow: 0 0 10px red;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —è–π—Ü–∞ */
        #egg-anim-layer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .egg-shake { font-size: 10rem; animation: shakeHard 0.5s infinite; }
        @keyframes shakeHard { 0%{transform:rotate(0)} 25%{transform:rotate(10deg)} 75%{transform:rotate(-10deg)} 100%{transform:rotate(0)} }
        
        .pet-reveal { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); font-size: 8rem; margin-bottom: 20px; }
        @keyframes popIn { 0%{transform:scale(0)} 100%{transform:scale(1)} }

        /* Toast */
        #toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #222; color: #fff; padding: 12px 30px; border-radius: 50px;
            font-weight: 700; border: 1px solid var(--accent-color);
            z-index: 9999; opacity: 0; transition: 0.4s;
        }
        #toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }

    </style>
</head>
<body>

    <canvas id="particles-canvas"></canvas>

    <div id="toast">Notification</div>

    <div id="egg-anim-layer">
        <div id="egg-stage-1" style="text-align:center;">
            <div class="egg-shake">üí©</div>
            <h1 style="color:white; font-family:'Shojumaru'; letter-spacing:3px; margin-top:20px;">CRACKING...</h1>
        </div>
        <div id="egg-stage-2" style="display:none; text-align:center;">
            <div id="res-emoji" class="pet-reveal"></div>
            <h2 id="res-name" style="color:white; text-transform:uppercase; font-size:2rem; margin:0;">NAME</h2>
            <h3 id="res-rarity" style="margin-top:5px; font-weight:900;">RARITY</h3>
            <button class="ui-btn primary" style="width:200px; margin-top:30px;" onclick="closeEgg()">OK</button>
        </div>
    </div>

    <div id="auth-wrapper" class="auth-wrapper">
        <div class="auth-box">
            <h1 class="ultimate-title">IDI NAHUI</h1>
            <p class="subtitle-text" id="auth-sub">—è –ø–æ—à–µ–ª –Ω–∞—Ö—É–π</p>
            
            <div class="lang-flags">
                <div class="flag-btn" id="fl-ru-auth" onclick="changeLang('ru')">
                    <span class="flag-img">üá∑üá∫</span>
                    <span class="flag-label">RU</span>
                </div>
                <div class="flag-btn" id="fl-en-auth" onclick="changeLang('en')">
                    <span class="flag-img">üá∫üá∏</span>
                    <span class="flag-label">EN</span>
                </div>
            </div>

            <input type="text" id="inp-login" class="nice-input" placeholder="Login">
            <input type="password" id="inp-pass" class="nice-input" placeholder="Password">
            
            <button class="ui-btn primary" id="btn-auth-main" onclick="processAuth()">–í–•–û–î</button>
            <p style="margin-top:15px; font-size:0.8rem; cursor:pointer; text-decoration:underline; opacity:0.7;" id="auth-toggle" onclick="toggleAuth()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>
    </div>

    <div id="game-layer" style="display:none; text-align:center; width:100%; position:relative; z-index:10;">
        
        <h1 class="ultimate-title">IDI NAHUI</h1>
        <p class="subtitle-text" id="game-sub">—è –ø–æ—à–µ–ª –Ω–∞—Ö—É–π</p>

        <div class="score-big" id="score-val">0</div>

        <div class="click-container" style="margin: 20px 0;">
            <button id="main-btn"></button>
        </div>

        <div class="bottom-label" id="unit-val">—Ä–∞–∑</div>

        <div class="dock-panel">
            <div class="dock-btn" onclick="openModal('shop')">üõí</div>
            <div class="dock-btn" onclick="openModal('inventory')">üéí</div>
            <div class="dock-btn" onclick="openModal('fortune')">üé°</div>
            <div class="dock-btn" onclick="openModal('settings')">‚öôÔ∏è</div>
            <div class="dock-btn" onclick="openModal('info')">‚ÑπÔ∏è</div>
        </div>

    </div>

    <div id="modal-shop" class="modal-overlay">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModals()">√ó</span>
            <div class="m-header"><h2 class="m-title" id="t-shop">SHOP</h2></div>
            
            <div class="shop-item">
                <div style="display:flex;align-items:center;">
                    <span class="item-icon">üí©</span>
                    <div class="item-details">
                        <div class="item-name" id="n-egg">–Ø–ô–¶–û –ì–û–í–ù–ê</div>
                        <div class="item-desc">Random Pet</div>
                    </div>
                </div>
                <button class="ui-btn primary" style="width:auto;" onclick="buyEgg()">200 üí∞</button>
            </div>

            <div class="shop-item">
                <div style="display:flex;align-items:center;">
                    <span class="item-icon">üåà</span>
                    <div class="item-details">
                        <div class="item-name" id="n-hearts">–†–ê–î–£–ñ–ù–´–ï –°–ï–†–î–¶–ê</div>
                        <div class="item-desc">Effect</div>
                    </div>
                </div>
                <button class="ui-btn info" id="buy-hearts-btn" style="width:auto;" onclick="buyItem('hearts', 5000)">5000 üí∞</button>
            </div>

            <div class="shop-item">
                <div style="display:flex;align-items:center;">
                    <span class="item-icon">üíø</span>
                    <div class="item-details">
                        <div class="item-name" id="n-rbtn">–†–ê–î–£–ñ–ù–ê–Ø –ö–ù–û–ü–ö–ê</div>
                        <div class="item-desc">Skin</div>
                    </div>
                </div>
                <button class="ui-btn info" id="buy-rbtn-btn" style="width:auto;" onclick="buyItem('rbtn', 10000)">10000 üí∞</button>
            </div>
        </div>
    </div>

    <div id="modal-inventory" class="modal-overlay">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModals()">√ó</span>
            <div class="m-header"><h2 class="m-title" id="t-inv">BACKPACK</h2></div>
            <div id="inv-list" class="inv-grid"></div>
        </div>
    </div>

    <div id="modal-fortune" class="modal-overlay">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModals()">√ó</span>
            <div class="m-header"><h2 class="m-title" id="t-fortune">FORTUNE</h2></div>
            
            <div class="fortune-container">
                <div class="fortune-arrow"></div>
                <div class="fortune-tape" id="fortune-tape"></div>
            </div>
            
            <button class="ui-btn primary" id="btn-spin" onclick="spin()">SPIN (50)</button>
        </div>
    </div>

    <div id="modal-info" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <span class="close-icon" onclick="closeModals()">√ó</span>
            <div class="m-header"><h2 class="m-title">INFO</h2></div>
            
            <h1 style="font-size:3rem; margin:10px 0; color:var(--accent-color);">BETA 8.0</h1>
            <p style="opacity:0.7; margin-bottom:30px;">beta test by XCX diva</p>
            <p style="opacity:0.7; margin-bottom:30px;">–§–æ—Ä—Ç—É–Ω–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!!! –≠—Ñ—Ñ–µ–∫—Ç—ã —Ç–æ–∂–µ!!!</p>

            <a href="https://t.me/Hfdhkdgk" target="_blank" style="text-decoration:none;">
                <button class="ui-btn info" style="background:#0088cc;">TELEGRAM</button>
            </a>
        </div>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModals()">√ó</span>
            <div class="m-header"><h2 class="m-title" id="t-set">SETTINGS</h2></div>

            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:15px;">
                <span id="lbl-acc" style="opacity:0.6; font-size:0.8rem;">Account:</span>
                <strong id="set-user" style="color:var(--accent-color); font-size:1.1rem; display:block;">User</strong>
            </div>

            <button class="ui-btn" onclick="toggleTheme()" id="btn-theme">CHANGE THEME</button>

            <p style="font-weight:900; margin-top:20px;" id="lbl-eff">EFFECTS:</p>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
                <button class="ui-btn" style="margin:0; padding:10px; background:#444;" onclick="setEffect('mats')">ü§¨</button>
                <button class="ui-btn" style="margin:0; padding:10px; background:#00a8ff;" onclick="setEffect('snow')">‚ùÑÔ∏è</button>
                <button class="ui-btn" style="margin:0; padding:10px; background:#ff4e50;" onclick="setEffect('hearts')">‚ù§Ô∏è</button>
                <button class="ui-btn" style="margin:0; padding:10px; background:#ff9a9e;" onclick="setEffect('pink')">üå∏</button>
                <button class="ui-btn" style="margin:0; padding:10px; background:#de2910;" onclick="setEffect('china')">üèÆ</button>
                <button class="ui-btn" style="margin:0; padding:10px; background:#654321;" onclick="setEffect('shit')">üí©</button>
                <button class="ui-btn locked" id="eff-rain-btn" style="margin:0; padding:10px; background:linear-gradient(45deg, red, blue);" onclick="buyItem('hearts', 5000)">üåà</button>
                <button class="ui-btn" style="margin:0; padding:10px; background:#333; grid-column:span 2;" onclick="setEffect('none')">OFF</button>
            </div>

            <p style="font-weight:900; margin-top:20px;" id="lbl-col">COLOR:</p>
            <div class="colors-container">
                <div class="c-dot" id="c1" style="background:linear-gradient(#ff4e50, #960000)" onclick="setColor(1, '#ff4e50', '#960000')"></div>
                <div class="c-dot" id="c2" style="background:linear-gradient(#4facfe, #00f2fe)" onclick="setColor(2, '#4facfe', '#00f2fe')"></div>
                <div class="c-dot" id="c3" style="background:linear-gradient(#43e97b, #38f9d7)" onclick="setColor(3, '#43e97b', '#38f9d7')"></div>
                <div class="c-dot" id="c4" style="background:linear-gradient(#f9d423, #ff4e50)" onclick="setColor(4, '#f9d423', '#ff4e50')"></div>
                <div class="c-dot" id="c5" style="background:linear-gradient(#a18cd1, #fbc2eb)" onclick="setColor(5, '#a18cd1', '#fbc2eb')"></div>
                <div class="c-dot" id="c6" style="background:linear-gradient(#8B4513, #A0522D)" onclick="setColor(6, '#8B4513', '#A0522D')"></div> <div class="c-dot" id="c7" style="background:linear-gradient(#ff9a9e, #fecfef)" onclick="setColor(7, '#ff9a9e', '#fecfef')"></div>
                <div class="c-dot" id="c8" style="background:linear-gradient(#30cfd0, #330867)" onclick="setColor(8, '#30cfd0', '#330867')"></div>
                <div class="c-dot" id="c9" style="background:linear-gradient(#6a11cb, #2575fc)" onclick="setColor(9, '#6a11cb', '#2575fc')"></div>
                <div class="c-dot locked" id="c10" style="background:linear-gradient(45deg, red, yellow, green, blue, violet)" onclick="buyItem('rbtn', 10000)"></div>
            </div>

            <div class="lang-flags">
                <div class="flag-btn" id="fl-ru-set" onclick="changeLang('ru')"><span class="flag-img">üá∑üá∫</span><span>RU</span></div>
                <div class="flag-btn" id="fl-en-set" onclick="changeLang('en')"><span class="flag-img">üá∫üá∏</span><span>EN</span></div>
            </div>

            <button class="ui-btn danger" style="margin-top:20px;" onclick="logout()" id="btn-logout">LOG OUT</button>
        </div>
    </div>

    <script>
        /**
         * GLOBAL CONFIG & DATA
         */
        const DB_NAME = 'idi_nahui_ultimate_db';
        let appState = {
            user: null,
            data: {}, // { pass, score, inv: {}, unlocks: [], activeColor: {}, activeEffect: '' }
            lang: 'ru',
            loginMode: true
        };

        const LOCALIZATION = {
            ru: {
                subtitle: "—è –ø–æ—à–µ–ª/–ø–æ—à–ª–∞ –Ω–∞—Ö—É–π",
                unit: "–†–ê–ó",
                login_btn: "–í–û–ô–¢–ò",
                reg_btn: "–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø",
                toggle_reg: "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
                toggle_login: "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í—Ö–æ–¥",
                shop: "–ú–ê–ì–ê–ó–ò–ù",
                inv: "–†–Æ–ö–ó–ê–ö",
                fortune: "–§–û–†–¢–£–ù–ê",
                set: "–ù–ê–°–¢–†–û–ô–ö–ò",
                egg_name: "–Ø–ô–¶–û –ì–û–í–ù–ê",
                r_hearts: "–†–ê–î–£–ñ–ù–´–ï –°–ï–†–î–¶–ê",
                r_btn: "–†–ê–î–£–ñ–ù–ê–Ø –ö–ù–û–ü–ö–ê",
                theme: "–°–ú–ï–ù–ò–¢–¨ –¢–ï–ú–£",
                lbl_acc: "–ê–∫–∫–∞—É–Ω—Ç:",
                lbl_eff: "–≠–§–§–ï–ö–¢–´:",
                lbl_col: "–¶–í–ï–¢ –ö–ù–û–ü–ö–ò:",
                logout: "–í–´–ô–¢–ò",
                spin: "–ö–†–£–¢–ò–¢–¨ (50)",
                open_txt: "–û–¢–ö–†–´–í–ê–ï–ú...",
                bought: "–ö–£–ü–õ–ï–ù–û!",
                no_money: "–ú–ê–õ–û –î–ï–ù–ï–ì, –ë–û–ú–ñ!",
                fill: "–ó–ê–ü–û–õ–ù–ò –ü–û–õ–Ø!",
                exists: "–ó–ê–ù–Ø–¢–û!",
                err: "–û–®–ò–ë–ö–ê!",
                rarity: { c: "–û–ë–´–ß–ù–´–ô", r: "–†–ï–î–ö–ò–ô", u: "–£–õ–¨–¢–†–ê", l: "–õ–ï–ì–ï–ù–î–ê–†–ù–´–ô" }
            },
            en: {
                subtitle: "i went to f**k off",
                unit: "TIMES",
                login_btn: "LOGIN",
                reg_btn: "REGISTER",
                toggle_reg: "No account? Register",
                toggle_login: "Have account? Login",
                shop: "SHOP",
                inv: "BACKPACK",
                fortune: "FORTUNE",
                set: "SETTINGS",
                egg_name: "SHIT EGG",
                r_hearts: "RAINBOW HEARTS",
                r_btn: "RAINBOW BUTTON",
                theme: "CHANGE THEME",
                lbl_acc: "Account:",
                lbl_eff: "EFFECTS:",
                lbl_col: "BUTTON COLOR:",
                logout: "LOG OUT",
                spin: "SPIN (50)",
                open_txt: "OPENING...",
                bought: "BOUGHT!",
                no_money: "NOT ENOUGH MONEY!",
                fill: "FILL FIELDS!",
                exists: "EXISTS!",
                err: "ERROR!",
                rarity: { c: "COMMON", r: "RARE", u: "ULTRA", l: "LEGENDARY" }
            }
        };

        const ITEMS = [
            { id: 0, ru: "–ü–æ—Ü–µ–ª—É–π –∞–ª–∫–∞—à–∞", en: "Drunkard's Kiss", r: 'c', icon: 'üíã', col: 'var(--rarity-common)' },
            { id: 1, ru: "–û–±–æ—Å—Ä–∞–Ω–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞", en: "Shitty Box", r: 'r', icon: 'üì¶', col: 'var(--rarity-rare)' },
            { id: 2, ru: "–¢—Ä–æ–π–Ω–∞—è –ø–∏–∑–¥–∞", en: "Triple Pussy", r: 'u', icon: 'üëÑ', col: 'var(--rarity-ultra)' },
            { id: 3, ru: "–ì–æ–≤–Ω–æ", en: "Piece of Shit", r: 'l', icon: 'üí©', col: 'var(--rarity-legend)' }
        ];

        const MATS = {
            ru: ["–•–£–ô", "–ü–ò–ó–î–ê", "–ë–õ–Ø–¢–¨", "–ï–ë–õ–ê–ù", "–°–£–ö–ê", "–ú–£–î–ê–ö", "–ò–î–ò –ù–ê–•–£–ô", "–ó–ê–õ–£–ü–ê", "–ì–û–ù–î–û–ù"],
            en: ["FUCK", "SHIT", "BITCH", "CUNT", "DICK", "ASSHOLE", "BASTARD", "STFU"]
        };

        /* =========================================
           CORE FUNCTIONS
           ========================================= */
        
        window.onload = () => {
            // Load DB
            const db = localStorage.getItem(DB_NAME);
            if(db) appState.data = JSON.parse(db);

            // Load Lang
            const lg = localStorage.getItem('idi_lang');
            if(lg) appState.lang = lg;
            applyLang();

            // Load Theme
            if(localStorage.getItem('idi_theme') === 'light') document.body.classList.add('light-mode');

            // Init Fortune
            initFortune();

            // Start Particle Loop
            initParticles();
        };

        function save() {
            localStorage.setItem(DB_NAME, JSON.stringify(appState.data));
        }

        /* --- AUTH SYSTEM --- */
        function toggleAuth() {
            appState.loginMode = !appState.loginMode;
            applyLang();
        }

        function processAuth() {
            const l = document.getElementById('inp-login').value.trim();
            const p = document.getElementById('inp-pass').value.trim();
            if(!l || !p) return showToast(LOCALIZATION[appState.lang].fill);

            if(appState.loginMode) {
                // Login
                if(appState.data[l] && appState.data[l].pass === p) {
                    login(l);
                } else {
                    showToast(LOCALIZATION[appState.lang].err);
                }
            } else {
                // Register
                if(appState.data[l]) return showToast(LOCALIZATION[appState.lang].exists);
                appState.data[l] = {
                    pass: p,
                    score: 0,
                    inventory: {},
                    unlocks: [], // ['rbtn', 'rhearts']
                    activeColor: { id: 1, s: '#ff4e50', e: '#960000' },
                    activeEffect: 'none'
                };
                save();
                showToast("OK! Login now.");
                toggleAuth();
            }
        }

        function login(user) {
            appState.user = user;
            document.getElementById('auth-wrapper').style.display = 'none';
            document.getElementById('game-layer').style.display = 'block';
            document.getElementById('set-user').innerText = user;
            
            // Restore state
            updateScoreUI();
            const d = appState.data[user];
            
            // Apply color
            setColor(d.activeColor.id, d.activeColor.s, d.activeColor.e, true); // true = no save
            
            // Apply effect
            startParticles(d.activeEffect);
            
            // Update UI locks
            if(d.unlocks.includes('rbtn')) {
                document.getElementById('c10').classList.remove('locked');
                document.getElementById('buy-rbtn-btn').innerText = LOCALIZATION[appState.lang].bought;
            }
            if(d.unlocks.includes('rhearts')) {
                document.getElementById('eff-rain-btn').classList.remove('locked');
                document.getElementById('buy-hearts-btn').innerText = LOCALIZATION[appState.lang].bought;
            }
        }

        function logout() {
            location.reload();
        }

        /* --- GAMEPLAY --- */
        document.getElementById('main-btn').addEventListener('pointerdown', (e) => {
            if(!appState.user) return;
            
            const u = appState.data[appState.user];
            u.score++;
            updateScoreUI();
            save();

            // 3D Visual Press
            e.target.style.transform = "scale(0.95)";
            
            // Floater
            const f = document.createElement('div');
            f.innerText = "+1";
            f.className = "click-float";
            f.style.left = e.clientX + 'px';
            f.style.top = e.clientY + 'px';
            document.body.appendChild(f);
            setTimeout(() => f.remove(), 700);

            // Particle Burst
            spawnBurst(e.clientX, e.clientY);
        });

        document.getElementById('main-btn').addEventListener('pointerup', (e) => {
            e.target.style.transform = "scale(1)";
        });

        function updateScoreUI() {
            document.getElementById('score-val').innerText = appState.data[appState.user].score;
        }

        /* --- SHOP & ITEMS --- */
        function buyEgg() {
            const u = appState.data[appState.user];
            if(u.score < 200) return showToast(LOCALIZATION[appState.lang].no_money);
            
            u.score -= 200;
            save();
            updateScoreUI();
            closeModals();

            // Animation
            const l = document.getElementById('egg-anim-layer');
            l.style.display = 'flex';
            document.getElementById('egg-stage-1').style.display = 'block';
            document.getElementById('egg-stage-2').style.display = 'none';

            setTimeout(() => {
                document.getElementById('egg-stage-1').style.display = 'none';
                document.getElementById('egg-stage-2').style.display = 'block';

                // RNG
                const r = Math.random() * 100;
                let item;
                if(r < 5) item = ITEMS[3]; // Legend
                else if(r < 20) item = ITEMS[2]; // Ultra
                else if(r < 50) item = ITEMS[1]; // Rare
                else item = ITEMS[0]; // Common

                // Save Item
                if(!u.inventory[item.id]) u.inventory[item.id] = 0;
                u.inventory[item.id]++;
                save();

                // UI
                const name = appState.lang === 'ru' ? item.ru : item.en;
                document.getElementById('res-emoji').innerText = item.icon;
                document.getElementById('res-name').innerText = name;
                document.getElementById('res-name').style.color = item.col;
                document.getElementById('res-rarity').innerText = LOCALIZATION[appState.lang].rarity[item.r];
                document.getElementById('res-rarity').style.color = item.col;

            }, 2500);
        }

        function closeEgg() {
            document.getElementById('egg-anim-layer').style.display = 'none';
        }

        function buyItem(type, cost) {
            const u = appState.data[appState.user];
            
            if(type === 'rbtn') {
                if(u.unlocks.includes('rbtn')) return setColor(10, 'rainbow', 'rainbow');
                if(u.score < cost) return showToast(LOCALIZATION[appState.lang].no_money);
                u.score -= cost;
                u.unlocks.push('rbtn');
                document.getElementById('c10').classList.remove('locked');
                setColor(10, 'rainbow', 'rainbow');
            }
            else if(type === 'hearts') {
                if(u.unlocks.includes('rhearts')) return setEffect('rainbow');
                if(u.score < cost) return showToast(LOCALIZATION[appState.lang].no_money);
                u.score -= cost;
                u.unlocks.push('rhearts');
                document.getElementById('eff-rain-btn').classList.remove('locked');
                setEffect('rainbow');
            }
            save();
            updateScoreUI();
            showToast(LOCALIZATION[appState.lang].bought);
        }

        /* --- INVENTORY --- */
        function renderInv() {
            const c = document.getElementById('inv-list');
            c.innerHTML = '';
            const u = appState.data[appState.user];
            
            ITEMS.forEach(it => {
                if(u.inventory[it.id] && u.inventory[it.id] > 0) {
                    const el = document.createElement('div');
                    let borderCol = it.col;
                    el.className = 'inv-item';
                    el.style.borderColor = borderCol;
                    el.innerHTML = `
                        <div class="inv-count">x${u.inventory[it.id]}</div>
                        <div style="font-size:2.5rem;">${it.icon}</div>
                        <div style="font-size:0.7rem; font-weight:700; color:${borderCol}; line-height:1.2; margin-top:5px;">
                            ${appState.lang==='ru'?it.ru:it.en}
                        </div>
                    `;
                    c.appendChild(el);
                }
            });
        }

        /* --- FORTUNE --- */
        function initFortune() {
            const tape = document.getElementById('fortune-tape');
            const icons = ['üí©', '+50', 'üí©', '+100', 'üíé', '+200', 'üí©', '+10'];
            let html = '';
            for(let i=0; i<50; i++) {
                icons.forEach(ic => html += `<div class="fortune-cell">${ic}</div>`);
            }
            tape.innerHTML = html;
        }

        function spinWheel() {
            const u = appState.data[appState.user];
            if(u.score < 50) return showToast(LOCALIZATION[appState.lang].no_money);
            
            u.score -= 50;
            updateScoreUI();
            save();

            const tape = document.getElementById('fortune-tape');
            const rand = Math.floor(Math.random() * 20) + 10;
            const shift = rand * 80; // 80px cell width
            
            tape.style.transform = `translateX(-${shift}px)`;
            
            setTimeout(() => {
                const win = Math.floor(Math.random() * 100);
                u.score += win;
                updateScoreUI();
                save();
                showToast(`WIN: ${win}`);
                tape.style.transition = 'none';
                tape.style.transform = 'translateX(0)';
                setTimeout(() => tape.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.1, 1)', 50);
            }, 4100);
        }

        /* --- SETTINGS & VISUALS --- */
        function setColor(id, s, e, noSave) {
            const u = appState.data[appState.user];
            // Check Lock
            if(id === 10 && u && !u.unlocks.includes('rbtn') && !noSave) {
                return showToast("LOCKED!");
            }

            const btn = document.getElementById('main-btn');
            btn.classList.remove('rainbow-mode-btn');
            btn.style.background = '';

            if(s === 'rainbow') {
                btn.classList.add('rainbow-mode-btn');
            } else {
                btn.style.background = `linear-gradient(135deg, ${s}, ${e})`;
            }

            // Update UI dots
            document.querySelectorAll('.c-dot').forEach(d => d.classList.remove('active'));
            const dot = document.getElementById('c'+id);
            if(dot) dot.classList.add('active');

            if(u && !noSave) {
                u.activeColor = { id, s, e };
                save();
            }
        }

        function setEffect(type) {
            const u = appState.data[appState.user];
            if(type === 'rainbow' && !u.unlocks.includes('rhearts')) {
                return showToast("LOCKED!");
            }
            if(u) {
                u.activeEffect = type;
                save();
            }
            activeEffectType = type;
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const m = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('idi_theme', m);
        }

        function changeLang(l) {
            appState.lang = l;
            localStorage.setItem('idi_lang', l);
            applyLang();
        }

        function applyLang() {
            const t = LOCALIZATION[appState.lang];
            const l = appState.lang;

            // Auth
            document.getElementById('auth-sub').innerText = t.subtitle;
            document.getElementById('auth-toggle').innerText = appState.loginMode ? t.toggle_reg : t.toggle_login;
            document.getElementById('btn-auth-main').innerText = appState.loginMode ? t.login_btn : t.reg_btn;
            document.getElementById('fl-ru-auth').classList.toggle('active', l==='ru');
            document.getElementById('fl-en-auth').classList.toggle('active', l==='en');

            // Game
            document.getElementById('game-sub').innerText = t.subtitle;
            document.getElementById('unit-display').innerText = t.unit;
            document.getElementById('t-shop').innerText = t.shop;
            document.getElementById('t-inv').innerText = t.inv;
            document.getElementById('t-fortune').innerText = t.fortune;
            document.getElementById('t-set').innerText = t.set;
            
            document.getElementById('n-egg').innerText = t.egg_name;
            document.getElementById('n-hearts').innerText = t.r_hearts;
            document.getElementById('n-rbtn').innerText = t.r_btn;
            
            document.getElementById('btn-theme').innerText = t.theme;
            document.getElementById('btn-logout').innerText = t.logout;
            document.getElementById('btn-spin').innerText = t.spin;
            
            document.getElementById('lbl-acc').innerText = t.lbl_acc;
            document.getElementById('lbl-eff').innerText = t.lbl_eff;
            document.getElementById('lbl-col').innerText = t.lbl_col;
            document.getElementById('eff-off').innerText = t.eff_off; // missing in dict? fixed logic below
            
            document.getElementById('fl-ru-set').classList.toggle('active', l==='ru');
            document.getElementById('fl-en-set').classList.toggle('active', l==='en');
        }

        /* --- PARTICLES SYSTEM (CANVAS) --- */
        const cvs = document.getElementById('particles-canvas');
        const ctx = cvs.getContext('2d');
        let particles = [];
        let activeEffectType = 'none';

        function initParticles() {
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            animateParticles();
        }

        function resizeCanvas() {
            cvs.width = window.innerWidth;
            cvs.height = window.innerHeight;
        }

        function startParticles(type) {
            activeEffectType = type;
        }

        function spawnBurst(x, y) {
            if(activeEffectType === 'none') return;
            // Burst logic for clicks
            for(let i=0; i<3; i++) createParticle(x, y, true);
        }

        function createParticle(x, y, isBurst) {
            if(activeEffectType === 'none') return;
            
            let text = '';
            let color = '#fff';
            let size = Math.random() * 20 + 10;
            
            if(activeEffectType === 'snow') text = '‚ùÑÔ∏è';
            else if(activeEffectType === 'hearts') text = '‚ù§Ô∏è';
            else if(activeEffectType === 'pink') text = Math.random()>0.5?'üå∏':'üíó';
            else if(activeEffectType === 'china') text = ['üèÆ','üßß','üê≤'][Math.floor(Math.random()*3)];
            else if(activeEffectType === 'shit') text = 'üí©';
            else if(activeEffectType === 'rainbow') text = 'üíñ'; // handled via hue
            else if(activeEffectType === 'mats') {
                const arr = appState.lang === 'ru' ? MATS.ru : MATS.en;
                text = arr[Math.floor(Math.random()*arr.length)];
                color = '#ff4e50';
                size = 20;
            }

            particles.push({
                x: x || Math.random() * cvs.width,
                y: y || -50,
                vx: isBurst ? (Math.random()-0.5)*10 : 0,
                vy: isBurst ? (Math.random()-0.5)*10 : Math.random() * 2 + 1,
                text: text,
                color: color,
                size: size,
                life: 1.0,
                hue: Math.random()*360,
                isRainbow: activeEffectType === 'rainbow'
            });
        }

        // Main Loop
        function animateParticles() {
            ctx.clearRect(0,0,cvs.width, cvs.height);
            
            // Auto spawn
            if(activeEffectType !== 'none' && Math.random() < 0.1) {
                createParticle();
            }

            for(let i=0; i<particles.length; i++) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.005;
                
                // Physics
                if(p.vx !== 0) p.vx *= 0.95; // friction
                if(!p.isBurst) p.y += 1; // gravity

                ctx.font = `900 ${p.size}px Montserrat`;
                
                if(p.isRainbow) {
                    p.hue += 5;
                    ctx.fillStyle = `hsl(${p.hue}, 100%, 50%)`;
                } else {
                    ctx.fillStyle = p.color;
                }
                
                ctx.globalAlpha = p.life;
                ctx.fillText(p.text, p.x, p.y);
                ctx.globalAlpha = 1;
            }

            particles = particles.filter(p => p.life > 0);
            requestAnimationFrame(animateParticles);
        }

        /* --- UI UTILS --- */
        function openModal(id) {
            closeModals();
            document.getElementById('modal-'+id).classList.add('open');
            if(id === 'inventory') renderInv();
        }
        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }

    </script>
</body>
</html>
