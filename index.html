<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Idi nahui clicker</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a; --container-bg: #2a2a2a; --text-color: #ffffff;
            --accent-color: #f9d423; --btn-grad-start: #ff4e50; --btn-grad-end: #960000;
            --input-bg: #333; --input-text: #ffffff;
            --rarity-0: #3498db; --rarity-1: #9b59b6; --rarity-2: #2ecc71; --rarity-3: #e74c3c; --rarity-4: #f1c40f;
        }
        .light-theme {
            --bg-color: #f0f0f0; --container-bg: #ffffff; --text-color: #1a1a1a;
            --accent-color: #ff4e50; --input-bg: #e0e0e0; --input-text: #1a1a1a;
        }
        body {
            margin: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Montserrat', sans-serif; display: flex; align-items: center;
            justify-content: center; height: 100vh; overflow: hidden; transition: 0.3s;
            user-select: none; touch-action: manipulation;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —è–π—Ü–∞ */
        #egg-opening-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 500; align-items: center; justify-content: center; flex-direction: column;
        }
        .egg-anim { font-size: 100px; animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0); } }
        .reveal-anim { animation: reveal 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards; font-size: 120px; }
        @keyframes reveal { 0% { transform: scale(0) rotate(-20deg); opacity: 0; } 100% { transform: scale(1) rotate(0); opacity: 1; } }

        #particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .particle { position: absolute; top: -20px; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }
        .click-plus { position: absolute; color: var(--accent-color); font-weight: 900; font-size: 35px; pointer-events: none; z-index: 100; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-panel { position: absolute; display: flex; z-index: 10; gap: 12px; }
        @media (min-width: 769px) { .nav-panel { top: 20px; left: 20px; flex-direction: column; align-items: center; } }
        @media (max-width: 768px) { .nav-panel { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 25px; backdrop-filter: blur(10px); width: 85%; justify-content: space-around; } }
        .nav-item { text-align: center; cursor: pointer; transition: 0.2s; }
        .nav-item:hover { transform: scale(1.15); }
        .nav-icon { font-size: 26px; display: block; }
        .key-hint { font-size: 10px; opacity: 0.6; font-weight: 700; display: block; }

        /* –û–∫–Ω–∞ */
        .modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--container-bg); padding: 25px; border-radius: 25px;
            box-shadow: 0 0 60px rgba(0,0,0,0.6); z-index: 30; text-align: center; width: 340px; max-height: 80vh; overflow-y: auto;
        }
        .modal-h { margin-top: 0; color: var(--accent-color); text-transform: uppercase; font-weight: 900; letter-spacing: 1px; }
        .shop-item { background: rgba(128,128,128,0.15); padding: 12px; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .buy-btn { background: #42e695; border: none; padding: 7px 15px; border-radius: 8px; cursor: pointer; font-weight: 900; color: #1a1a1a; }
        
        .inventory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .pet-card { background: rgba(0,0,0,0.25); border-radius: 12px; padding: 10px; font-size: 0.7rem; border-bottom: 4px solid #ccc; }

        /* –¶–≤–µ—Ç–∞ */
        .color-options { display: flex; justify-content: space-around; margin: 20px 0; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 18px; }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .color-dot.active { border-color: #fff; transform: scale(1.15); }

        /* –§–ª–∞–≥–∏ */
        .lang-container { background: rgba(128,128,128,0.1); padding: 10px; border-radius: 15px; margin: 15px 0; display: flex; justify-content: center; gap: 30px; }
        .lang-item { position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 55px; height: 55px; justify-content: center; overflow: hidden; border-radius: 10px; }
        .flag-bg { position: absolute; width: 100%; height: 100%; opacity: 0.6; z-index: -1; }
        .flag-ru { background: linear-gradient(#fff 33.3%, #0039a6 33.3%, #0039a6 66.6%, #d52b1e 66.6%); }
        .flag-us { background: linear-gradient(to bottom, #b22234 0%, #b22234 14.2%, #fff 14.2%, #fff 28.4%, #b22234 28.4%, #b22234 42.6%, #fff 42.6%, #fff 56.8%, #b22234 56.8%, #b22234 71%, #fff 71%, #fff 85.2%, #b22234 85.2%); position: relative; }
        .flag-us::before { content: ''; position: absolute; top: 0; left: 0; width: 45%; height: 50%; background: #3c3b6e; }

        /* –§–æ—Ä—Ç—É–Ω–∞ */
        .fortune-container { position: relative; width: 100%; height: 90px; background: #000; border: 4px solid var(--accent-color); border-radius: 15px; overflow: hidden; margin: 20px 0; }
        .fortune-tape { display: flex; position: absolute; left: 0; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); }
        .fortune-slot { min-width: 70px; height: 90px; display: flex; align-items: center; justify-content: center; font-size: 30px; border-right: 1px solid #222; }
        .fortune-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 5px; height: 100%; background: #ff4e50; z-index: 5; box-shadow: 0 0 10px rgba(255,78,80,0.5); }

        #click-button {
            width: 230px; height: 230px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, var(--btn-grad-start), var(--btn-grad-end));
            box-shadow: 0 12px 50px rgba(0,0,0,0.5); cursor: pointer;
            transition: transform 0.05s; outline: none;
        }
        #click-button:active { transform: scale(0.9); }

        .auth-container { background: var(--container-bg); padding: 35px; border-radius: 30px; text-align: center; width: 320px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
        input { width: 88%; padding: 14px; margin: 10px 0; border-radius: 12px; border: none; background: var(--input-bg); color: var(--input-text); font-family: 'Montserrat'; font-weight: 700; }
        .menu-btn { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border: none; border-radius: 12px; background: #444; color: white; font-weight: 800; font-family: 'Montserrat'; text-transform: uppercase; }
        
        #game-ui { display: none; text-align: center; }
        #toast { visibility: hidden; min-width: 220px; background: #333; color: #fff; text-align: center; border-radius: 15px; padding: 18px; position: fixed; z-index: 1000; left: 50%; bottom: 60px; transform: translateX(-50%); opacity: 0; transition: 0.4s; font-weight: 700; }
        #toast.show { visibility: visible; opacity: 1; }

        .rarity-0 { border-color: var(--rarity-0) !important; color: var(--rarity-0); }
        .rarity-1 { border-color: var(--rarity-1) !important; color: var(--rarity-1); }
        .rarity-2 { border-color: var(--rarity-2) !important; color: var(--rarity-2); }
        .rarity-3 { border-color: var(--rarity-3) !important; color: var(--rarity-3); }
        .rarity-4 { border-color: var(--rarity-4) !important; color: var(--rarity-4); }
    </style>
</head>
<body>

    <div id="particles-container"></div>
    <div id="toast"></div>

    <div id="egg-opening-overlay">
        <div id="opening-egg-icon" class="egg-anim">ü•ö</div>
        <h2 id="opening-text" style="color: white; margin-top: 25px; font-weight: 900;">–û–¢–ö–†–´–¢–ò–ï...</h2>
        <div id="pet-reveal" style="display:none; text-align:center;">
            <div id="revealed-pet-emoji" class="reveal-anim"></div>
            <h1 id="revealed-pet-name" style="margin: 15px 0; font-size: 2.5rem; font-weight: 900;"></h1>
            <h3 id="revealed-pet-rarity" style="text-transform: uppercase; letter-spacing: 2px;"></h3>
            <button class="menu-btn" style="width:180px; background:var(--accent-color); color:#000; margin-top: 20px;" onclick="closeEggAnimation()">OK</button>
        </div>
    </div>
    
    <div id="nav-ui" class="nav-panel" style="display: none;">
        <div class="nav-item" onclick="toggleModal('settings-panel')"><span class="nav-icon">‚öôÔ∏è</span><span class="key-hint">[O]</span></div>
        <div class="nav-item" onclick="toggleModal('shop-modal')"><span class="nav-icon">üõí</span><span class="key-hint">[S]</span></div>
        <div class="nav-item" onclick="toggleModal('fortune-modal')"><span class="nav-icon">üé°</span><span class="key-hint">[F]</span></div>
        <div class="nav-item" onclick="toggleModal('inventory-modal')"><span class="nav-icon">üéí</span><span class="key-hint">[I]</span></div>
        <div class="nav-item" onclick="showSoon('trade')"><span class="nav-icon">ü§ù</span><span class="key-hint">[R]</span></div>
    </div>

    <div id="auth-ui" class="auth-container">
        <div class="brand-name" style="font-size: 2rem;"><b>Idi nahui clicker</b></div>
        <div class="lang-container">
            <div class="lang-item" onclick="setLang('ru')"><div class="flag-bg flag-ru"></div><span class="lang-label">RU</span></div>
            <div class="lang-item" onclick="setLang('en')"><div class="flag-bg flag-us"></div><span class="lang-label">US</span></div>
        </div>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω / Login">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å / Password">
        <button class="menu-btn" style="background: #ff4e50; color: white;" id="main-auth-btn" onclick="handleAuth()">–í–æ–π—Ç–∏</button>
        <span style="display:block; margin-top:25px; cursor:pointer; font-size:0.85rem; opacity:0.8; font-weight: 700;" onclick="toggleMode()" id="toggle-mode">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
    </div>

    <div id="shop-modal" class="modal">
        <h2 class="modal-h" id="h-shop">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div id="egg-list">
            <div class="shop-item"><span id="egg1-name">üí© –Ø–π—Ü–æ 1</span> <b>200</b> <button class="buy-btn" onclick="startEggOpening(1)">BUY</button></div>
            <div class="shop-item"><span id="egg2-name">üñï –Ø–π—Ü–æ 2</span> <b>500</b> <button class="buy-btn" onclick="startEggOpening(2)">BUY</button></div>
            <div class="shop-item"><span id="egg3-name">üçë –Ø–π—Ü–æ 3</span> <b>1000</b> <button class="buy-btn" onclick="startEggOpening(3)">BUY</button></div>
        </div>
        <button class="menu-btn" onclick="closeAll()" id="btn-close-shop">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="inventory-modal" class="modal">
        <h2 class="modal-h" id="h-inv">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        <div class="inventory-grid" id="inv-grid"></div>
        <button class="menu-btn" onclick="closeAll()" id="btn-close-inv">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="fortune-modal" class="modal">
        <h2 class="modal-h" id="h-fortune">–§–æ—Ä—Ç—É–Ω–∞</h2>
        <div class="fortune-container">
            <div class="fortune-pointer"></div>
            <div id="fortune-tape" class="fortune-tape"></div>
        </div>
        <button class="menu-btn" style="background: var(--accent-color); color: #000;" onclick="spinFortune()" id="btn-spin">–ö–†–£–¢–ò–¢–¨ (50)</button>
        <button class="menu-btn" onclick="closeAll()" id="btn-close-fortune">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="settings-panel" class="modal">
        <h2 class="modal-h" id="h-set">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.15); border-radius: 12px;">
            <span id="set-acc-label" style="font-size: 0.8rem; opacity: 0.7;">–ê–∫–∫–∞—É–Ω—Ç:</span><br>
            <b id="current-user-name" style="color: var(--accent-color); font-size: 1.2rem;">---</b>
        </div>
        <button class="menu-btn" id="btn-theme" onclick="toggleTheme()">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
        
        <div class="color-options">
            <div class="color-dot" id="dot-red" style="background: linear-gradient(#ff4e50, #960000);" onclick="changeBtnColor('#ff4e50', '#960000', 'red')"></div>
            <div class="color-dot" id="dot-blue" style="background: linear-gradient(#4facfe, #003366);" onclick="changeBtnColor('#4facfe', '#003366', 'blue')"></div>
            <div class="color-dot" id="dot-green" style="background: linear-gradient(#42e695, #1a5e3a);" onclick="changeBtnColor('#42e695', '#1a5e3a', 'green')"></div>
            <div class="color-dot" id="dot-gold" style="background: linear-gradient(#f9d423, #b59500);" onclick="changeBtnColor('#f9d423', '#b59500', 'gold')"></div>
        </div>

        <div class="lang-container">
            <div class="lang-item" onclick="setLang('ru')"><div class="flag-bg flag-ru"></div><span class="lang-label">RU</span></div>
            <div class="lang-item" onclick="setLang('en')"><div class="flag-bg flag-us"></div><span class="lang-label">US</span></div>
        </div>
        <button class="menu-btn" style="background: #ff4e50; margin-top: 20px;" onclick="location.reload()" id="btn-logout">–í—ã–π—Ç–∏</button>
        <button class="menu-btn" onclick="closeAll()" id="btn-close-settings">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="game-ui">
        <h1 class="brand-name" style="font-size: 2.5rem; margin-bottom: 5px;"><b>Idi nahui clicker</b></h1>
        <div class="subtitle" id="game-sub" style="font-weight: 700; opacity: 0.7; margin-bottom: 20px;">—è –ø–æ—à–µ–ª/–ø–æ—à–ª–∞ –Ω–∞—Ö—É–π</div>
        <div id="score-container" style="font-size: 5rem; font-weight: 900; line-height: 1;">0</div>
        <div id="game-unit" style="font-weight: 900; color: var(--accent-color); font-size: 1.8rem; margin-bottom: 30px;">—Ä–∞–∑</div>
        <button id="click-button"></button>
    </div>

    <script>
        let isLoginMode = true; let currentUser = null;
        let currentLang = localStorage.getItem('lang') || 'ru';
        let users = JSON.parse(localStorage.getItem('clicker_users')) || {};
        let isKeyPressed = false;

        const PETS_DATA = {
            egg1: [{n: "–ú—É—Ö–∞", en: "Fly", e: "ü™∞", r: 0}, {n: "–ö—Ä—ã—Å–∞", en: "Rat", e: "üêÄ", r: 1}, {n: "–°–∫—É–Ω—Å", en: "Skunk", e: "ü¶®", r: 2}, {n: "–ó–æ–º–±–∏", en: "Zombie", e: "üßü", r: 3}, {n: "–ö–æ—Ä–æ–ª—å –ù–∞–≤–æ–∑–∞", en: "Dung King", e: "üëë", r: 4}],
            egg2: [{n: "–°–º–∞–π–ª–∏–∫", en: "Emoji", e: "üòÄ", r: 0}, {n: "–ö–∞–∫—Ç—É—Å", en: "Cactus", e: "üåµ", r: 1}, {n: "–ë–æ–∫—Å–µ—Ä", en: "Boxer", e: "ü•ä", r: 2}, {n: "–¢—Ä–æ–ª–ª—å", en: "Troll", e: "üë∫", r: 3}, {n: "–ú–∞—Å—Ç–µ—Ä", en: "Master", e: "üßô", r: 4}],
            egg3: [{n: "–ú—ã–ª–æ", en: "Soap", e: "üßº", r: 0}, {n: "–£—Ç–∫–∞", en: "Duck", e: "ü¶Ü", r: 1}, {n: "–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫", en: "Plumber", e: "üë®‚Äçüîß", r: 2}, {n: "–£–Ω–∏—Ç–∞–∑", en: "Toilet", e: "üöΩ", r: 3}, {n: "–ë–æ–≥ –ü–æ–ø", en: "Butt God", e: "üçë", r: 4}]
        };

        const rarityNames = {
            ru: ["–û–±—ã—á–Ω—ã–π", "–ù–µ–æ–±—ã—á–Ω—ã–π", "–†–µ–¥–∫–∏–π", "–£–ª—å—Ç—Ä–∞-–†–µ–¥–∫–∏–π", "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π"],
            en: ["Common", "Uncommon", "Rare", "Ultra-Rare", "Legendary"]
        };

        const texts = {
            ru: { 
                login: "–í–æ–π—Ç–∏", reg: "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç", noAcc: "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", hasAcc: "–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏", fill: "–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!", err: "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!", 
                shop: "–ú–∞–≥–∞–∑–∏–Ω", inv: "–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å", sub: "—è –ø–æ—à–µ–ª/–ø–æ—à–ª–∞ –Ω–∞—Ö—É–π", unit: "—Ä–∞–∑", logout: "–í—ã–π—Ç–∏", close: "–ó–∞–∫—Ä—ã—Ç—å",
                set: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", theme: "–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É", spin: "–ö–†–£–¢–ò–¢–¨ (50)", opening: "–û–¢–ö–†–´–¢–ò–ï...", low: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤!",
                accLabel: "–ê–∫–∫–∞—É–Ω—Ç:", egg1: "üí© –Ø–π—Ü–æ 1", egg2: "üñï –Ø–π—Ü–æ 2", egg3: "üçë –Ø–π—Ü–æ 3", tradeSoon: "–¢—Ä–µ–π–¥—ã —Å–∫–æ—Ä–æ!"
            },
            en: { 
                login: "Login", reg: "Sign Up", noAcc: "No account? Register", hasAcc: "Have an account? Login", fill: "Fill all fields!", err: "Login Error!", 
                shop: "Shop", inv: "Backpack", sub: "i went to f**k off", unit: "times", logout: "Logout", close: "Close",
                set: "Settings", theme: "Change Theme", spin: "SPIN (50)", opening: "OPENING...", low: "Not enough points!",
                accLabel: "Account:", egg1: "üí© Egg 1", egg2: "üñï Egg 2", egg3: "üçë Egg 3", tradeSoon: "Trades soon!"
            }
        };

        window.onload = function() {
            setLang(currentLang);
            if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-theme');
            let savedColor = JSON.parse(localStorage.getItem('btnColor')) || {start: '#ff4e50', end: '#960000', id: 'red'};
            changeBtnColor(savedColor.start, savedColor.end, savedColor.id);
            initFortune();
        };

        function setLang(l) {
            currentLang = l; localStorage.setItem('lang', l);
            const t = texts[l];
            document.getElementById('main-auth-btn').innerText = isLoginMode ? t.login : t.reg;
            document.getElementById('toggle-mode').innerText = isLoginMode ? t.noAcc : t.hasAcc;
            document.getElementById('game-sub').innerText = t.sub;
            document.getElementById('game-unit').innerText = t.unit;
            document.getElementById('h-inv').innerText = t.inv;
            document.getElementById('h-shop').innerText = t.shop;
            document.getElementById('h-set').innerText = t.set;
            document.getElementById('btn-theme').innerText = t.theme;
            document.getElementById('set-acc-label').innerText = t.accLabel;
            document.getElementById('btn-close-shop').innerText = t.close;
            document.getElementById('btn-close-inv').innerText = t.close;
            document.getElementById('btn-close-settings').innerText = t.close;
            document.getElementById('btn-close-fortune').innerText = t.close;
            document.getElementById('btn-logout').innerText = t.logout;
            document.getElementById('btn-spin').innerText = t.spin;
            document.getElementById('opening-text').innerText = t.opening;
            document.getElementById('egg1-name').innerText = t.egg1;
            document.getElementById('egg2-name').innerText = t.egg2;
            document.getElementById('egg3-name').innerText = t.egg3;
        }

        function handleAuth() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(!u || !p) return showToast(texts[currentLang].fill);
            if (isLoginMode) {
                if (users[u] && users[u].password === p) { 
                    currentUser = u; 
                    document.getElementById('auth-ui').style.display='none'; 
                    document.getElementById('game-ui').style.display='block'; 
                    document.getElementById('nav-ui').style.display='flex'; 
                    document.getElementById('current-user-name').innerText=u; 
                    document.getElementById('score-container').innerText=users[u].score;
                    updateInvGrid();
                } else showToast(texts[currentLang].err);
            } else {
                if (users[u]) showToast("User exists!");
                else { users[u] = {password:p, score:0, pets:[]}; save(); toggleMode(); showToast("Success!"); }
            }
        }

        function startEggOpening(type) {
            let cost = [0, 200, 500, 1000][type];
            if (users[currentUser].score < cost) return showToast(texts[currentLang].low);
            
            users[currentUser].score -= cost;
            document.getElementById('score-container').innerText = users[currentUser].score;
            closeAll();
            
            const overlay = document.getElementById('egg-opening-overlay');
            overlay.style.display = 'flex';
            document.getElementById('opening-egg-icon').style.display = 'block';
            document.getElementById('opening-text').style.display = 'block';
            document.getElementById('pet-reveal').style.display = 'none';

            setTimeout(() => {
                const pool = PETS_DATA['egg'+type];
                let rand = Math.random() * 100;
                let rIdx = rand < 3 ? 4 : (rand < 12 ? 3 : (rand < 30 ? 2 : (rand < 60 ? 1 : 0)));
                const pet = pool[rIdx];
                
                users[currentUser].pets.push({n: pet.n, en: pet.en, e: pet.e, r: rIdx});
                save();
                updateInvGrid();

                document.getElementById('opening-egg-icon').style.display = 'none';
                document.getElementById('opening-text').style.display = 'none';
                const reveal = document.getElementById('pet-reveal');
                reveal.style.display = 'block';
                document.getElementById('revealed-pet-emoji').innerText = pet.e;
                document.getElementById('revealed-pet-name').innerText = (currentLang === 'ru' ? pet.n : pet.en);
                const rarityLabel = document.getElementById('revealed-pet-rarity');
                rarityLabel.innerText = rarityNames[currentLang][rIdx];
                rarityLabel.className = `rarity-${rIdx}`;
            }, 2500);
        }

        function closeEggAnimation() { document.getElementById('egg-opening-overlay').style.display = 'none'; }

        function spinFortune() {
            if (users[currentUser].score < 50) return showToast(texts[currentLang].low);
            users[currentUser].score -= 50; save();
            document.getElementById('score-container').innerText = users[currentUser].score;
            const tape = document.getElementById('fortune-tape');
            const randomSlot = Math.floor(Math.random() * 10) + 40; 
            tape.style.transform = `translateX(-${randomSlot * 70 - 135}px)`;
            setTimeout(() => {
                const items = ['üí©', '+10', 'üí©', '+100', 'üé°', 'üíé', 'üí©', '+10', 'üí©', '+50'];
                const win = items[randomSlot % 10];
                if(win === 'üíé') users[currentUser].score += 1000;
                else if(win.includes('+')) users[currentUser].score += parseInt(win.replace('+',''));
                save();
                document.getElementById('score-container').innerText = users[currentUser].score;
                showToast(win);
                setTimeout(() => { tape.style.transition='none'; tape.style.transform='translateX(0)'; setTimeout(()=>tape.style.transition='transform 4s cubic-bezier(0.1, 0, 0.1, 1)', 50); }, 500);
            }, 4100);
        }

        function changeBtnColor(start, end, id) {
            document.documentElement.style.setProperty('--btn-grad-start', start);
            document.documentElement.style.setProperty('--btn-grad-end', end);
            localStorage.setItem('btnColor', JSON.stringify({start, end, id}));
            document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('active'));
            if(document.getElementById('dot-' + id)) document.getElementById('dot-' + id).classList.add('active');
        }

        function updateInvGrid() {
            const grid = document.getElementById('inv-grid');
            grid.innerHTML = '';
            users[currentUser].pets.forEach(p => {
                const div = document.createElement('div');
                div.className = `pet-card rarity-${p.r}`;
                div.innerHTML = `<span style="font-size:1.8rem">${p.e}</span><br><b>${currentLang === 'ru' ? p.n : p.en}</b>`;
                grid.appendChild(div);
            });
        }

        function doClick(e) {
            if(!currentUser) return;
            users[currentUser].score++; save();
            document.getElementById('score-container').innerText = users[currentUser].score;
            const anim = document.createElement('div');
            anim.className = 'click-plus'; anim.innerText = '+1';
            anim.style.left = (e ? e.pageX : window.innerWidth/2) + 'px';
            anim.style.top = (e ? e.pageY : window.innerHeight/2) + 'px';
            document.body.appendChild(anim);
            anim.animate([{opacity:1},{transform:'translateY(-120px)',opacity:0}], 600);
            setTimeout(() => anim.remove(), 600);
        }

        function initFortune() {
            const tape = document.getElementById('fortune-tape');
            const items = ['üí©', '+10', 'üí©', '+100', 'üé°', 'üíé', 'üí©', '+10', 'üí©', '+50'];
            for(let i=0; i<80; i++) {
                const s = document.createElement('div'); s.className='fortune-slot'; s.innerText=items[i%10]; tape.appendChild(s);
            }
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            const isOpen = m.style.display === 'block';
            closeAll(); if(!isOpen) m.style.display = 'block';
        }
        function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function showSoon(key) { showToast(texts[currentLang].tradeSoon); }
        function save() { localStorage.setItem('clicker_users', JSON.stringify(users)); }
        function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.className = "show"; setTimeout(() => t.className = "", 2500); }
        function toggleMode() { isLoginMode = !isLoginMode; setLang(currentLang); }
        function toggleTheme() { document.body.classList.toggle('light-theme'); localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark'); }
        
        document.getElementById('click-button').addEventListener('click', (e) => doClick(e));
        window.addEventListener('keydown', (e) => {
            if (!currentUser || isKeyPressed) return;
            isKeyPressed = true;
            const key = e.key.toLowerCase();
            if (key === 'e' || key === '—É') doClick(null);
            if (key === 'o' || key === '—â') toggleModal('settings-panel');
            if (key === 's' || key === '—ã') toggleModal('shop-modal');
            if (key === 'f' || key === '–∞') toggleModal('fortune-modal');
            if (key === 'i' || key === '—à') toggleModal('inventory-modal');
        });
        window.addEventListener('keyup', () => isKeyPressed = false);
    </script>
</body>
</html>
